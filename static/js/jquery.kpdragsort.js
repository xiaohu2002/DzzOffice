/*
 * @copyright   Leyun internet Technology(Shanghai)Co.,Ltd
 * @license     http://www.dzzoffice.com/licenses/license.txt
 * @package     DzzOffice
 * @link        http://www.dzzoffice.com
 * @author      zyx(zyx@dzz.cc)
 */
!function(t){t.fn.kpdragsort=function(e,n){var o={scrollContainer:t(".bs-main-container"),contentContainer:t(".main-content")};e=t.extend(o,e);var i,r,s,a,l,c,p,h,d,u,f,g,m=this,v=jQuery('<div class="nokpdrager"  unselectable="on" onselectstart="return event.srcElement.type== \'text\';" style="display:none; url(dzz/images/b.gif); z-index:10000;width:100%;height:100%;margin:0;padding:0; right: 0px; bottom: 0px;position: absolute; top:0px; left: 0px;"></div>').appendTo(e.contentContainer);t(m).children().addTouch(),t(m).children().off("mousedown").mousedown(function(e){if(!(t(this).hasClass("nokpdrager")||1!=e.which||t(e.target).is("input, textarea")||window.kp_only)){var n=this;try{e.preventDefault?e.preventDefault():e.returnvalue=!1}catch(e){}a=setTimeout(function(){w(e.clientX,e.clientY,n,e)},200)}}),t(m).children().off("mouseup").mouseup(function(t){window.kp_only||clearTimeout(a)});var w=function(o,a,w,k){s=t(w),d=isNaN(parseInt(s.css("margin-left")))?0:parseInt(s.css("margin-left")),u=isNaN(parseInt(s.css("margin-top")))?0:parseInt(s.css("margin-top")),f=isNaN(parseInt(s.css("margin-right")))?0:parseInt(s.css("margin-right")),g=isNaN(parseInt(s.css("margin-bottom")))?0:parseInt(s.css("margin-bottom")),p=e.scrollContainer.height(),c=e.scrollContainer.scrollTop(),l=e.contentContainer.outerHeight(!0);try{k.preventDefault?k.preventDefault():k.returnvalue=!1}catch(k){}h=e.scrollContainer.offset();var _=o,y=a,b=s.outerWidth(),x=s.outerHeight(),C=b/2,T=x/2,I=s.offset(),N=s.position(),D=N.left,z=N.top;i=_-I.left,r=y-I.top,window.kp_only=!0,v.show(),s.before('<div id="kp_widget_holder"></div>');var H=t("#kp_widget_holder");H.css({border:"2px dashed #ccc",float:"left",marginLeft:d,marginTop:u,marginRight:f,marginBottom:g,height:s.outerHeight(!0)-u-g,width:s.outerWidth(!0)-d-f}),s.css({width:b,height:x,position:"absolute",opacity:.8,"z-index":999,left:D,top:z}),t(document).mousemove(function(n){n=n||window.event;try{n.preventDefault?n.preventDefault():n.returnValue=!1}catch(n){}var o=n.clientX,a=n.clientY;a-r<h.top&&c>0?((c=c+a-r-h.top)<0&&(c=0),e.scrollContainer.scrollTop(c)):a+(s.height()-r)>=p+h.top&&((c=c+a+(s.height()-r)-p-h.top)>l-p&&(c=l-p),e.scrollContainer.scrollTop(c));var d=a-r-h.top+c,u=o-i-h.left;s.css({left:u,top:d});var f=u+C,g=d+T;t(m).children().not(s).not(H).not(".nokpdrager").each(function(e){var n=t(this),o=n.position(),i=o.left,r=o.left+n.width(),s=o.top,a=o.top+n.height();i<f&&f<r&&s<g&&g<a&&(n.next("#kp_widget_holder").length?H.insertBefore(this):H.insertAfter(this))})}),t(document).mouseup(function(e){t(document).off("mouseup").off("mousemove"),t(m).each(function(){var e=t(this).children(),n=e.length;1==n&&e.is(s)?t("<div></div>").appendTo(this).attr("class","kp_widget_block").css({height:100}):2==n&&e.is(".kp_widget_block")&&t(this).children(".kp_widget_block").remove()});var o=H.position();s.animate({left:o.left,top:o.top},200,function(){s.removeAttr("style"),H.replaceWith(s),"function"==typeof n&&n(),window.kp_only=null,v.hide()})})}}}(jQuery);