/* @authorcode  codestrings
 * @copyright   Leyun internet Technology(Shanghai)Co.,Ltd
 * @license     http://www.dzzoffice.com/licenses/license.txt
 * @package     DzzOffice
 * @link        http://www.dzzoffice.com
 * @author      zyx(zyx@dzz.cc)
 */
!function(t){t.fn.dragsort=function(o,n){var r={scrollContainer:t(".bs-main-container"),contentContainer:t(".main-content"),hoder_div_css:"position:relative;background:#f7f7f7;border:1px solid #e1e1e1",width_correct:0,height_correct:0};o=t.extend(r,o);var i,s,a,c,d,l,u,h,p,f,g,m,v,b,w=0,_=o.scrollContainer.offset();Math.max(document.documentElement.clientWidth,document.body.offsetWidth);if(jQuery("#_blank").length)var y=jQuery("#_blank");else y=jQuery('<div id="_blank" class="nokpdrager"  unselectable="on" onselectstart="return event.srcElement.type== \'text\';" style="display:none; url(dzz/images/b.gif); z-index:10000;width:100%;height:100%;margin:0;padding:0; right: 0px; bottom: 0px;position: absolute; top:0px; left: 0px;"></div>').appendTo(o.contentContainer);t(this).children().off("mousedown.subdrager").on("mousedown.subdrager",function(e){if(!(t(this).hasClass("nodrager")||1!=e.which||t(e.target).is("input, textarea")||t(e.target).closest(".nodrager").length||window.kp_only)){jQuery("input").trigger("blur");try{e.preventDefault?e.preventDefault():e.returnvalue=!1}catch(e){}return m=t(this),u=e.clientX,h=e.clientY,v=m.offset(),b=m.position(),l=b.left,d=b.top-o.scrollContainer.scrollTop(),e.clientX-v.left,i=e.clientY-v.top,t(document).on("mousemove.subdrager",function(e){e=e||window.event;try{e.preventDefault?e.preventDefault():e.returnValue=!1}catch(e){}var n=e.clientX,r=e.clientY;if(window.kp_only||u==n&&h==r||x(),window.kp_only){r-i<=_.top?((w+=r-i-_.top>-50?-50:r-i-_.top)<0&&(w=0),o.scrollContainer.scrollTop(w)):r+(m.height()-i)>=c+_.top&&((w+=r+(m.height()-i)-c-_.top<50?50:r+(m.height()-i)-c-_.top)>a-c&&(w=a-c),o.scrollContainer.scrollTop(w));var d=r-i-(v.top-b.top)+w;m.css({top:d});var l=r-i+g;t(s).parent().children().not(m).not(s).not(".nodrager").each(function(e){var o=t(this),n=o.offset(),r=n.top,i=n.top+o.height(),a=n.top+o.height()/2;r<l&&l<i&&(l>a?s.insertAfter(this):s.insertBefore(this))})}}),!1}}),t(this).children().off("mouseup").mouseup(function(e){window.kp_only||t(document).off("mousemove.subdrager")});var x=function(){window.kp_only=!0,y.show(),p=m.outerWidth(!0),f=m.outerHeight(!0),p/2,g=f/2,c=o.scrollContainer.height(),Math.max(document.documentElement.clientWidth,document.body.offsetWidth),w=o.scrollContainer.scrollTop(),0,a=o.contentContainer.outerHeight(!0),scrollWidth=o.contentContainer.outerWidth(!0);try{e.preventDefault?e.preventDefault():e.returnvalue=!1}catch(t){}m.before('<div id="kp_widget_holder" style="'+o.hoder_div_css+'"></div>'),(s=t("#kp_widget_holder")).css({height:m.outerHeight(!0)-o.height_correct,width:m.outerWidth(!0)-o.width_correct}),m.css({width:p-o.width_correct,height:f-o.height_correct,position:"absolute",opacity:.9,"z-index":999,left:l-o.width_correct,top:d-o.height_correct,border:"1px solid #e1e1e1",background:"#fbfbfb","box-shadow":"1px 1px 1px RGBA(0,0,0,0.7)"}),t(document).on("mouseup.subdrager",function(e){t(document).off("mouseup.subdrager").off("mousemove.subdrager");var o=s.position();o.top+=w;var r={};r.subid=m.attr("subid"),r.taskid=m.attr("taskid"),r.prevsubid=s.prev()?s.prev(".todo-item").attr("subid"):0,m.animate({left:o.left-parseInt(s.css("margin-left")),top:o.top-parseInt(s.css("margin-top"))},300,function(){m.removeAttr("style"),s.replaceWith(m),"function"==typeof n&&n(r),y.hide(),window.kp_only=null})})}}}(jQuery);